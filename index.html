<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFlow | Ù†Ø¸Ø§Ù… Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.35s ease; }
        .active-tab { background: #eef2ff; color: #3730a3 !important; border-bottom: 3px solid #4f46e5; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-10">

<header class="bg-slate-900 text-white sticky top-0 z-40 shadow-xl">
    <div class="container mx-auto px-4 py-5 flex flex-col md:flex-row items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-black text-indigo-300">EduFlow</h1>
            <p class="text-sm text-slate-300">Ø³ÙŠØ³ØªÙ… Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ÙƒÙˆØ±Ø³Ø§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</p>
        </div>
        <button onclick="startScanner()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-bold transition">ğŸ“· Ù…Ø³Ø­ Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„Ù€ QR</button>
    </div>
</header>

<main class="container mx-auto px-4 mt-8 max-w-6xl">
    <div class="grid grid-cols-2 md:grid-cols-5 bg-white border rounded-2xl overflow-hidden shadow-sm mb-8 text-sm md:text-base">
        <button id="btn-students" onclick="showTab('students')" class="tab-btn active-tab py-4 font-bold">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <button id="btn-courses" onclick="showTab('courses')" class="tab-btn py-4 font-bold border-r">ğŸ“š Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</button>
        <button id="btn-attendance" onclick="showTab('attendance')" class="tab-btn py-4 font-bold border-r">ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        <button id="btn-grades" onclick="showTab('grades')" class="tab-btn py-4 font-bold border-r">ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
        <button id="btn-reports" onclick="showTab('reports')" class="tab-btn py-4 font-bold border-r col-span-2 md:col-span-1">âš ï¸ Ø§Ù„ØºÙŠØ§Ø¨</button>
    </div>

    <section id="students" class="tab-content active">
        <div class="bg-white p-6 rounded-3xl border shadow-sm mb-6">
            <h2 class="text-xl font-black text-slate-800 mb-4">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <input id="stdName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="p-3 rounded-xl bg-slate-50 border">
                <input id="stdPhone" type="tel" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" class="p-3 rounded-xl bg-slate-50 border">
                <input id="stdCenter" type="text" placeholder="Ø§Ù„ÙØ±Ø¹ / Ø§Ù„Ø³Ù†ØªØ±" class="p-3 rounded-xl bg-slate-50 border">
                <select id="stdYear" class="p-3 rounded-xl bg-slate-50 border">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
                    <option>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option>Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    <option>Ø«Ø§Ù†ÙˆÙŠ</option>
                </select>
            </div>
            <button onclick="addStudent()" class="mt-4 w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        </div>
        <div id="studentsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-5"></div>
    </section>

    <section id="courses" class="tab-content">
        <div class="bg-white p-6 rounded-3xl border shadow-sm mb-6">
            <h2 class="text-xl font-black text-slate-800 mb-4">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input id="courseName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³" class="p-3 rounded-xl bg-slate-50 border">
                <input id="courseTeacher" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³" class="p-3 rounded-xl bg-slate-50 border">
                <input id="courseSchedule" type="text" placeholder="Ø§Ù„Ù…ÙˆØ¹Ø¯ (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø£Ø­Ø¯ 6Ù…)" class="p-3 rounded-xl bg-slate-50 border">
            </div>
            <button onclick="addCourse()" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ±Ø³</button>
        </div>
        <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <section id="attendance" class="tab-content">
        <div class="bg-white p-6 rounded-3xl border shadow-sm">
            <div class="flex flex-col md:flex-row gap-3 justify-between items-center mb-4">
                <h2 class="text-xl font-black text-slate-800">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
                <input id="attDate" type="date" onchange="renderAttendance();renderAbsence()" class="p-3 rounded-xl border bg-slate-50">
            </div>
            <div id="attList" class="space-y-3"></div>
        </div>
    </section>

    <section id="grades" class="tab-content">
        <div class="bg-white p-6 rounded-3xl border shadow-sm mb-6">
            <h2 class="text-xl font-black text-slate-800 mb-4">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <select id="gradeStudentSelect" class="p-3 rounded-xl bg-slate-50 border"></select>
                <input id="examName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±" class="p-3 rounded-xl bg-slate-50 border">
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <input id="gradeValue" type="number" placeholder="Ø¯Ø±Ø¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨" class="p-3 rounded-xl bg-slate-50 border text-center font-bold">
                <input id="maxGrade" type="number" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©" class="p-3 rounded-xl bg-slate-50 border text-center font-bold">
                <button onclick="sendGrade()" class="bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold">ØªØ³Ø¬ÙŠÙ„ + Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>
        </div>
        <div class="bg-white p-6 rounded-3xl border shadow-sm overflow-x-auto">
            <table class="w-full text-right">
                <thead class="text-slate-500 text-sm border-b">
                    <tr>
                        <th class="pb-3">Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                        <th class="pb-3">Ø§Ù„ÙØ±Ø¹</th>
                        <th class="pb-3">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                        <th class="pb-3">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                    </tr>
                </thead>
                <tbody id="gradesTableBody"></tbody>
            </table>
        </div>
    </section>

    <section id="reports" class="tab-content">
        <div class="bg-white p-6 rounded-3xl border shadow-sm">
            <h2 class="text-xl font-black text-slate-800 mb-4">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†</h2>
            <div id="absenceList" class="space-y-3"></div>
        </div>
    </section>
</main>

<div id="scanModal" class="modal">
    <div class="bg-white rounded-3xl p-6 w-[95%] max-w-lg">
        <h3 class="font-black text-lg mb-3">Ù…Ø³Ø­ QR Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
        <div id="reader" class="rounded-2xl overflow-hidden"></div>
        <p id="scanMsg" class="mt-4 text-sm text-slate-600">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¥Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨.</p>
        <button onclick="stopScanner()" class="mt-4 w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    let students = JSON.parse(localStorage.getItem('students') || '[]');
    let attendance = JSON.parse(localStorage.getItem('attendance') || '{}');
    let grades = JSON.parse(localStorage.getItem('grades') || '[]');
    let courses = JSON.parse(localStorage.getItem('courses') || '[]');
    let html5QrCode;

    function save() {
        localStorage.setItem('students', JSON.stringify(students));
        localStorage.setItem('attendance', JSON.stringify(attendance));
        localStorage.setItem('grades', JSON.stringify(grades));
        localStorage.setItem('courses', JSON.stringify(courses));
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active-tab'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-' + id).classList.add('active-tab');
        if (id === 'attendance') renderAttendance();
        if (id === 'reports') renderAbsence();
        if (id === 'grades') renderGradesTable();
        if (id === 'courses') renderCourses();
    }

    function addStudent() {
        const name = document.getElementById('stdName').value.trim();
        const phone = document.getElementById('stdPhone').value.trim();
        const center = document.getElementById('stdCenter').value.trim();
        const year = document.getElementById('stdYear').value;
        if (!name || !phone || !center || !year) return alert('Ø£ÙƒÙ…Ù„ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨.');

        students.push({ id: Date.now(), name, phone, center, year });
        save();
        renderStudents();
        ['stdName', 'stdPhone', 'stdCenter'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('stdYear').value = '';
    }

    function addCourse() {
        const name = document.getElementById('courseName').value.trim();
        const teacher = document.getElementById('courseTeacher').value.trim();
        const schedule = document.getElementById('courseSchedule').value.trim();
        if (!name || !teacher || !schedule) return alert('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³.');
        courses.push({ id: Date.now(), name, teacher, schedule });
        save();
        renderCourses();
        ['courseName', 'courseTeacher', 'courseSchedule'].forEach(id => document.getElementById(id).value = '');
    }

    function renderStudents() {
        const grid = document.getElementById('studentsGrid');
        grid.innerHTML = students.map(s => `
            <div class="bg-white p-5 rounded-3xl border shadow-sm flex flex-col items-center">
                <div id="qr-${s.id}" class="mb-3"></div>
                <h3 class="font-black text-slate-800">${s.name}</h3>
                <p class="text-xs text-slate-500 mt-1">${s.year} - ${s.center}</p>
                <button onclick="delStd(${s.id})" class="mt-3 text-red-500 text-xs font-bold">Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            </div>
        `).join('');
        students.forEach(s => new QRCode(document.getElementById(`qr-${s.id}`), { text: JSON.stringify({ id: s.id }), width: 96, height: 96 }));
        updateSelects();
    }

    function renderCourses() {
        document.getElementById('coursesGrid').innerHTML = courses.map(c => `
            <div class="bg-white p-5 rounded-3xl border shadow-sm">
                <h3 class="font-black text-slate-800">${c.name}</h3>
                <p class="text-sm text-slate-600 mt-2">Ø§Ù„Ù…Ø¯Ø±Ø³: <span class="font-bold">${c.teacher}</span></p>
                <p class="text-sm text-slate-600">Ø§Ù„Ù…ÙˆØ¹Ø¯: <span class="font-bold">${c.schedule}</span></p>
                <button onclick="delCourse(${c.id})" class="mt-3 text-red-500 text-xs font-bold">Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³</button>
            </div>
        `).join('') || '<p class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª Ø¨Ø¹Ø¯.</p>';
    }

    function updateSelects() {
        document.getElementById('gradeStudentSelect').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>' +
            students.map(s => `<option value="${s.id}">${s.name} (${s.center})</option>`).join('');
    }

    function renderAttendance() {
        const date = document.getElementById('attDate').value;
        if (!attendance[date]) attendance[date] = {};
        document.getElementById('attList').innerHTML = students.map(s => {
            const log = attendance[date][s.id];
            return `<div class="p-4 rounded-2xl border ${log ? 'bg-emerald-50 border-emerald-200' : 'bg-white'} flex justify-between items-center">
                <span class="font-bold">${s.name} (${s.center})</span>
                <span class="text-xs font-black">${log ? 'âœ… ' + log.time : 'ØºØ§Ø¦Ø¨'}</span>
            </div>`;
        }).join('') || '<p class="text-slate-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
    }

    function renderAbsence() {
        const date = document.getElementById('attDate').value;
        const absents = students.filter(s => !attendance[date]?.[s.id]);
        document.getElementById('absenceList').innerHTML = absents.map(s => `
            <div class="p-4 bg-rose-50 border border-rose-200 rounded-2xl flex justify-between items-center">
                <div>
                    <h4 class="font-black text-slate-800 text-sm">${s.name}</h4>
                    <p class="text-xs text-rose-600">${s.center}</p>
                </div>
                <button onclick="sendAbsenceWA('${s.phone}', '${s.name}', '${s.center}')" class="bg-rose-600 text-white px-4 py-2 rounded-lg text-xs font-bold">ØªØ¨Ù„ÙŠØº ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
            </div>
        `).join('') || '<p class="text-slate-500">Ù…Ù…ØªØ§Ø²! Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨.</p>';
    }

    function renderGradesTable() {
        document.getElementById('gradesTableBody').innerHTML = grades.slice().reverse().map(g => `
            <tr class="border-b text-sm">
                <td class="py-3 font-bold text-slate-700">${g.name}</td>
                <td class="text-slate-500">${g.center}</td>
                <td>${g.exam}</td>
                <td class="font-black text-emerald-600">${g.score}/${g.max}</td>
            </tr>
        `).join('') || '<tr><td colspan="4" class="py-3 text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯.</td></tr>';
    }

    function startScanner() {
        document.getElementById('scanModal').classList.add('active');
        html5QrCode = new Html5Qrcode('reader');
        html5QrCode.start({ facingMode: 'environment' }, { fps: 10, qrbox: 230 }, text => {
            const data = JSON.parse(text);
            const std = students.find(s => s.id == data.id);
            const date = document.getElementById('attDate').value;
            if (std && date && !attendance[date]?.[std.id]) {
                const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
                if (!attendance[date]) attendance[date] = {};
                attendance[date][std.id] = { time };
                save();
                renderAttendance();
                renderAbsence();
                document.getElementById('scanMsg').innerText = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${std.name}`;
                const msg = `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ${std.name} Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© ${time}.`;
                window.open(`https://wa.me/2${std.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        }).catch(() => {
            document.getElementById('scanMsg').innerText = 'ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.';
        });
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => document.getElementById('scanModal').classList.remove('active'));
        } else {
            document.getElementById('scanModal').classList.remove('active');
        }
    }

    function sendGrade() {
        const id = document.getElementById('gradeStudentSelect').value;
        const exam = document.getElementById('examName').value.trim();
        const score = document.getElementById('gradeValue').value;
        const max = document.getElementById('maxGrade').value;
        if (!id || !exam || !score || !max) return alert('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø©.');

        const std = students.find(s => s.id == id);
        grades.push({ name: std.name, center: std.center, exam, score, max });
        save();
        renderGradesTable();

        const msg = `Ù†ØªÙŠØ¬Ø© ${exam}: ${score} Ù…Ù† ${max} Ù„Ù„Ø·Ø§Ù„Ø¨ ${std.name}.`;
        window.open(`https://wa.me/2${std.phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function sendAbsenceWA(phone, name, center) {
        const msg = `ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} Ù„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„ÙŠÙˆÙ… ÙÙŠ ${center}.`;
        window.open(`https://wa.me/2${phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function delStd(id) {
        if (confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
            students = students.filter(s => s.id !== id);
            save();
            renderStudents();
            renderAttendance();
            renderAbsence();
        }
    }

    function delCourse(id) {
        if (confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³ØŸ')) {
            courses = courses.filter(c => c.id !== id);
            save();
            renderCourses();
        }
    }

    document.getElementById('attDate').value = new Date().toISOString().split('T')[0];
    renderStudents();
    renderCourses();
    renderAttendance();
    renderGradesTable();
    renderAbsence();
</script>

</body>
</html>
